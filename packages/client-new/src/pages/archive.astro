---
import BaseLayout from "../layouts/BaseLayout.astro";
import Card from "../components/Card.astro";

import { DatabaseTypes } from "f1racepanel-common";
import { getSecret } from "astro:env/server";

const currentYear = new Date().getFullYear();
let gpSeasons: (DatabaseTypes.Season | null)[] = [];

const API_URL = getSecret("API_URL");

for (let i = currentYear; i >= 1950; i--) {
  const API_SEASONS_URL = `${API_URL}/season/${i}`;

  const rawRes = await fetch(API_SEASONS_URL);

  if (rawRes.status === 404) {
    gpSeasons.push(null);
    continue;
  }

  const rawJSON = await rawRes.json();
  const season = DatabaseTypes.Season.parse(rawJSON);

  gpSeasons.push(season);
}
---

<BaseLayout title="Archive">
  <div class="grid grid-cols-4 gap-4">
    {
      gpSeasons.map((season: DatabaseTypes.Season | null, index: number) => {
        if (!season) {
          return (
            <Card title={`${currentYear - index}`}>
              <h3>{currentYear - index} - Not Available</h3>
            </Card>
          );
        }
      })
    }
  </div>
</BaseLayout>
